name: Test metagraph rewards

on:
  pull_request: {}
  push:
    branches:
      - develop
      - hotfix/*
      - release/*

jobs:
  build:
    name: Test rewards
    runs-on: ubuntu-20.04
    timeout-minutes: 45
    strategy:
      matrix:
        java:
          - openjdk@1.11.0
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 16.14.2
          cache: 'npm'
          cache-dependency-path: .github/action_scripts/package-lock.json

      - name: Installing node-fetch@2.6.6
        run: |
          cd .github/action_scripts
          npm i node-fetch@2.6.6

      - name: Setup Java and scala
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          JAVA_VERSION: ${{ matrix.java }}
        uses: "./.github/templates/setup_java_and_scala"

      - name: Generating Metagraph dependencies - kernel
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error kernel/publishM2

      - name: Generating Metagraph dependencies - keytool
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error keytool/publishM2
          
      - name: Generating Metagraph dependencies - sdk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error sdk/publishM2

      - name: Generating Metagraph dependencies - currencyL0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error currencyL0/publishM2

      - name: Generating Metagraph dependencies - currencyL1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error currencyL1/publishM2

      - name: Generating Metagraph dependencies - shared
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error shared/publishM2

      - name: Generating Metagraph dependencies - dagL1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt --error dagL1/publishM2

      - name: Run Global L0 Cluster
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: "./.github/templates/global_l0/gl0_cluster"

      - name: Run Metagraph L0 Cluster
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          IMPLEMENT_REWARDS: true
        uses: "./.github/templates/metagraph_l0/ml0_cluster"

      - name: Run Metagraph L1 Cluster
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: "./.github/templates/metagraph_l1/ml1_cluster"

      - name: Check Metagraph cluster
        run: |
          cd .github/action_scripts/check_clusters
          node metagraph.js

      - name: Check rewards
        run: |
          cd .github/action_scripts/rewards
          node index.js

      - name: Wait 1 minute before check cluster
        run: |
          sleep 60

      ## Checking cluster again because we already faced scenarios where the cluster dies after sending rewards transactions
      - name: Check Metagraph cluster
        run: |
          cd .github/action_scripts/check_clusters
          node metagraph.js

      - name: Save Global L0 Genesis logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-global-l0-genesis-java-${{ matrix.java }}
          path: .github/config/containers/global-l0/genesis/global-l0-genesis.log

      - name: Save Global L0 - Validator 1 logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-global-l0-validator-1-java-${{ matrix.java }}
          path: .github/config/containers/global-l0/validator-1/global-l0-validator-1.log

      - name: Save Global L0 - Validator 2 logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-global-l0-validator-2-java-${{ matrix.java }}
          path: .github/config/containers/global-l0/validator-2/global-l0-validator-2.log

      - name: Save Metagraph L0 - Genesis logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-metagraph-l0-genesis-java-${{ matrix.java }}
          path: .github/config/containers/metagraph-l0/genesis/metagraph-l0-genesis.log

      - name: Save Metagraph L0 - Validator 1 logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-metagraph-l0-validator-1-java-${{ matrix.java }}
          path: .github/config/containers/metagraph-l0/validator-1/metagraph-l0-validator-1.log

      - name: Save Metagraph L0 - Validator 2 logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-metagraph-l0-validator-2-java-${{ matrix.java }}
          path: .github/config/containers/metagraph-l0/validator-2/metagraph-l0-validator-2.log

      - name: Save Metagraph L1 - Initial Validator logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-metagraph-l1-initial-validator-java-${{ matrix.java }}
          path: .github/config/containers/metagraph-l1/initial-validator/metagraph-l1-initial-validator.log

      - name: Save Metagraph L1 - Validator 1 logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-metagraph-l1-validator-1-java-${{ matrix.java }}
          path: .github/config/containers/metagraph-l1/validator-1/metagraph-l1-1.log

      - name: Save Metagraph L1 - Validator 2 logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rewards-metagraph-l1-validator-2-java-${{ matrix.java }}
          path: .github/config/containers/metagraph-l1/validator-2/metagraph-l1-2.log